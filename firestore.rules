rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is an Owner (checks Firestore 'users' doc directly)
    function isOrgOwner(orgId) {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc.data.roles[orgId] == 'org_owner' || userDoc.data.roles[orgId] == 'owner';
    }

    // Check if user is a Member of the Org (checks Firestore 'users' doc directly)
    function isOrgMember(orgId) {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return orgId in userDoc.data.orgIds;
    }

    // Check if user is a Platform Admin (checks Firestore 'users' doc directly)
    function isPlatformAdmin() {
       let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
       return userDoc.data.globalRole == 'platform_owner' || userDoc.data.globalRole == 'platform_admin';
    }

    // --- RULES ---

    // Users: Allow reading/writing own profile
    match /users/{userId} {
      allow read, update: if request.auth != null && (
        request.auth.uid == userId || isPlatformAdmin()
      );
      // Allow creation if it matches auth UID (Critical for registration)
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && isPlatformAdmin();
    }

    // Orgs
    match /orgs/{orgId} {
      allow list: if request.auth != null && isPlatformAdmin();
      // Allow read if member
      allow read: if request.auth != null && (isOrgMember(orgId) || isPlatformAdmin());
      // Allow update if Owner or Admin
      allow update: if request.auth != null && (isOrgOwner(orgId) || isPlatformAdmin());
      // Allow create by anyone (Authentication required)
      allow create: if request.auth != null; 
      allow delete: if false;

      match /catalogItems/{itemId} {
        allow read: if request.auth != null && (isOrgMember(orgId) || isPlatformAdmin());
        allow write: if request.auth != null && (isOrgOwner(orgId) || isPlatformAdmin());
      }
    }
    
    // Entitlements
    match /entitlements/{orgId} {
      allow read: if request.auth != null && (isOrgMember(orgId) || isPlatformAdmin());
      allow update: if request.auth != null && (isOrgOwner(orgId) || isPlatformAdmin());
      allow create: if request.auth != null; 
      allow delete: if false;
    }

    // Projects
    match /projects/{projectId} {
      allow read: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
      allow create: if request.auth != null && (isOrgMember(request.resource.data.orgId) || isPlatformAdmin());
      allow update, delete: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
    }

    // Clients
    match /clients/{clientId} {
      allow read: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
      allow create: if request.auth != null && (isOrgMember(request.resource.data.orgId) || isPlatformAdmin());
      allow update, delete: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
    }

    // Rooms (Nested lookup required)
    match /rooms/{roomId} {
       // Note: complex nested gets can be expensive, but necessary here
      allow read: if request.auth != null &&
                  isOrgMember(get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.orgId);
      allow create: if request.auth != null && isOrgMember(request.resource.data.orgId);
      allow update, delete: if request.auth != null &&
                            isOrgMember(get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.orgId);
    }

    // Quotes
    match /quotes/{quoteId} {
      allow read: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
      allow create: if request.auth != null && (isOrgMember(request.resource.data.orgId) || isPlatformAdmin());
      allow update, delete: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
    }

    // Employees
    match /employees/{employeeId} {
      allow read: if request.auth != null && (
        request.auth.uid == employeeId ||
        isOrgMember(resource.data.orgId) || 
        isPlatformAdmin()
      );
      // Critical: Allow self-creation matching UID
      allow create: if request.auth != null && (
        request.auth.uid == employeeId || 
        (isOrgOwner(request.resource.data.orgId)) || 
        isPlatformAdmin()
      );
      allow update, delete: if request.auth != null && (
        (isOrgOwner(resource.data.orgId)) || 
        isPlatformAdmin()
      );
    }

    // Crews
    match /crews/{crewId} {
      allow read: if request.auth != null && (isOrgMember(resource.data.orgId) || isPlatformAdmin());
      allow create: if request.auth != null && (isOrgOwner(request.resource.data.orgId) || isPlatformAdmin());
      allow update, delete: if request.auth != null && (isOrgOwner(resource.data.orgId) || isPlatformAdmin());
    }

    match /portalTokens/{tokenId} {
      allow read, write: if false;
    }
  }
}
